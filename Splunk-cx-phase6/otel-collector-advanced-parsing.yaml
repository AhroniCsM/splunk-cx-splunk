# Advanced OTEL Config - Attempt to Parse Splunk TCP Protocol
# Using tcplog receiver with operators to extract log content

receivers:
  tcplog:
    listen_address: "0.0.0.0:9997"
    max_log_size: 5MiB
    add_attributes: false
    operators:
      # Try to parse Splunk's cooked mode protocol
      - type: regex_parser
        regex: '^--splunk-cooked-mode.*?_raw(?P<log_body>.*)$'
        parse_from: body
        parse_to: attributes
      # If above doesn't work, try to extract after certain markers
      - type: regex_parser
        regex: 'sourcetype.*?\n(?P<actual_log>.*)'
        parse_from: body
        parse_to: attributes
        if: 'body contains "sourcetype"'
      # Try to split on newlines and get the last part
      - type: regex_parser
        regex: '(?s).*\n(?P<log_content>[^\n]+)$'
        parse_from: body
        parse_to: attributes

processors:
  batch:
    timeout: 10s
    send_batch_size: 100
  resource:
    attributes:
      - key: environment
        value: production
        action: upsert
      - key: phase
        value: "6-k8s-tcp-advanced"
        action: upsert
  attributes:
    actions:
      - key: collector
        value: ec2-otel-tcplog-advanced
        action: insert
  # Add debug processor to see what we're getting
  transform:
    log_statements:
      - context: log
        statements:
          # Try to extract content after the protocol header
          - set(body, body) where IsMatch(body, "(?s).*_raw(.*)") == true

exporters:
  splunk_hec/logs:
    token: "YOUR_SPLUNK_HEC_TOKEN"
    endpoint: "https://your-instance.splunkcloud.com:8088"
    source: "k8s-phase6-tcp-advanced"
    sourcetype: "python:phase6:k8s"
    index: "main"
    tls:
      insecure_skip_verify: true
  coralogix:
    domain: "eu2.coralogix.com"
    private_key: "YOUR_CORALOGIX_PRIVATE_KEY"
    application_name: "k8s-phase6-tcp-advanced"
    subsystem_name: "kubernetes-central-advanced"
    timeout: 30s
  debug:
    verbosity: detailed
    sampling_initial: 10
    sampling_thereafter: 100

service:
  pipelines:
    logs:
      receivers: [tcplog]
      processors: [batch, resource, attributes, transform]
      exporters: [splunk_hec/logs, coralogix, debug]
  telemetry:
    logs:
      level: debug

